# MetaNodeè´¨æŠ¼æŒ–çŸ¿ç³»ç»Ÿ

ä¸€ä¸ªåŸºäºä»¥å¤ªåŠçš„å»ä¸­å¿ƒåŒ–è´¨æŠ¼æŒ–çŸ¿å¹³å°ï¼Œæ”¯æŒETHå’ŒERC20ä»£å¸è´¨æŠ¼ï¼Œé€šè¿‡æ™ºèƒ½åˆçº¦è‡ªåŠ¨åˆ†å‘MetaNodeä»£å¸å¥–åŠ±ã€‚

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

MetaNodeè´¨æŠ¼æŒ–çŸ¿ç³»ç»Ÿæ˜¯ä¸€ä¸ªå®Œæ•´çš„DeFiè´¨æŠ¼è§£å†³æ–¹æ¡ˆï¼Œå…·æœ‰ä»¥ä¸‹æ ¸å¿ƒç‰¹æ€§ï¼š

### ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

- **å¤šå¸ç§è´¨æŠ¼æ”¯æŒ**ï¼šæ”¯æŒETHå’Œå¤šç§ERC20ä»£å¸è´¨æŠ¼
- **çµæ´»å¥–åŠ±æœºåˆ¶**ï¼šåŸºäºåŒºå—é«˜åº¦å’Œæ± æƒé‡çš„å…¬å¹³å¥–åŠ±åˆ†é…
- **å»¶è¿Ÿæå–ä¿æŠ¤**ï¼šå¯é…ç½®çš„é”å®šæœŸé˜²æ­¢çŸ­æœŸæŠ•æœº
- **ç®¡ç†å‘˜æ§åˆ¶**ï¼šå®Œå–„çš„æƒé™ç®¡ç†å’Œç´§æ€¥æš‚åœæœºåˆ¶
- **å¯å‡çº§æ¶æ„**ï¼šä½¿ç”¨UUPSæ¨¡å¼æ”¯æŒåˆçº¦é€»è¾‘å‡çº§
- **å®‰å…¨ä¿éšœ**ï¼šåŸºäºOpenZeppelinæ ‡å‡†åº“ï¼Œç»è¿‡å……åˆ†æµ‹è¯•

### ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
MetaNodeè´¨æŠ¼æŒ–çŸ¿ç³»ç»Ÿ
â”œâ”€â”€ MetaNodeToken.sol          # å¥–åŠ±ä»£å¸åˆçº¦
â”œâ”€â”€ MetaNodeStake.sol          # ä¸»è´¨æŠ¼åˆçº¦
â”œâ”€â”€ scripts/                   # éƒ¨ç½²å’Œäº¤äº’è„šæœ¬
â”‚   â”œâ”€â”€ deploy.js             # å®Œæ•´ç³»ç»Ÿéƒ¨ç½²
â”‚   â”œâ”€â”€ addPool.js            # æ·»åŠ èµ„é‡‘æ± 
â”‚   â”œâ”€â”€ MetaNodeStake.js      # Sepoliaç½‘ç»œéƒ¨ç½²
â”‚   â””â”€â”€ tokenInteract.js      # åˆçº¦äº¤äº’æµ‹è¯•
â””â”€â”€ test/                     # æµ‹è¯•æ–‡ä»¶
    â””â”€â”€ MetaNodeStake.test.js # ç»¼åˆæµ‹è¯•å¥—ä»¶
```

## ğŸ”§ æŠ€æœ¯æ ˆ

- **æ™ºèƒ½åˆçº¦**ï¼šSolidity ^0.8.20
- **å¼€å‘æ¡†æ¶**ï¼šHardhat
- **å‡çº§æ¨¡å¼**ï¼šOpenZeppelin UUPS
- **æ ‡å‡†åº“**ï¼šOpenZeppelin Contracts
- **æµ‹è¯•å·¥å…·**ï¼šHardhat + Ethers.js
- **ç½‘ç»œæ”¯æŒ**ï¼šä»¥å¤ªåŠä¸»ç½‘ã€Sepoliaæµ‹è¯•ç½‘ã€æœ¬åœ°å¼€å‘ç½‘ç»œ

## ğŸ“Š åˆçº¦è¯¦è§£

### MetaNodeToken.sol - å¥–åŠ±ä»£å¸

```solidity
// æ ‡å‡†ERC20ä»£å¸ï¼Œç”¨ä½œè´¨æŠ¼å¥–åŠ±
contract MetaNodeToken is ERC20 {
    // æ€»ä¾›åº”é‡ï¼š10,000,000 MetaNode
    // ç²¾åº¦ï¼š18ä½å°æ•°
    // ç‰¹ç‚¹ï¼šå›ºå®šä¾›åº”é‡ï¼Œæ— å¢å‘æœºåˆ¶
}
```

**å…³é”®ç‰¹æ€§ï¼š**
- âœ… æ ‡å‡†ERC20åŠŸèƒ½
- âœ… é¢„é“¸é€ 1000ä¸‡ä»£å¸
- âœ… æ— é¢å¤–ç®¡ç†æƒé™
- âœ… å»ä¸­å¿ƒåŒ–è®¾è®¡

### MetaNodeStake.sol - ä¸»è´¨æŠ¼åˆçº¦

```solidity
// å¯å‡çº§çš„å¤šæ± è´¨æŠ¼æŒ–çŸ¿åˆçº¦
contract MetaNodeStake is 
    Initializable, 
    UUPSUpgradeable, 
    PausableUpgradeable, 
    AccessControlUpgradeable {
    
    // æ”¯æŒå¤šä¸ªèµ„é‡‘æ± 
    // åŸºäºåŒºå—çš„å¥–åŠ±åˆ†å‘
    // å»¶è¿Ÿæå–æœºåˆ¶
    // å®Œå–„çš„æƒé™æ§åˆ¶
}
```

**æ ¸å¿ƒæ•°æ®ç»“æ„ï¼š**

```solidity
struct Pool {
    address stTokenAddress;      // è´¨æŠ¼ä»£å¸åœ°å€ï¼ˆ0x0 = ETHï¼‰
    uint256 poolWeight;          // æ± æƒé‡ï¼ˆå†³å®šå¥–åŠ±åˆ†é…ï¼‰
    uint256 lastRewardBlock;     // ä¸Šæ¬¡æ›´æ–°åŒºå—
    uint256 accMetaNodePerST;    // ç´¯ç§¯æ¯ä»£å¸å¥–åŠ±
    uint256 stTokenAmount;       // æ± å†…æ€»è´¨æŠ¼é‡
    uint256 minDepositAmount;    // æœ€å°è´¨æŠ¼é™åˆ¶
    uint256 unstakeLockedBlocks; // æå–é”å®šæœŸ
}

struct User {
    uint256 stAmount;         // ç”¨æˆ·è´¨æŠ¼é‡
    uint256 finishedMetaNode; // å·²ç»“ç®—å¥–åŠ±
    uint256 pendingMetaNode;  // å¾…é¢†å–å¥–åŠ±
    UnstakeRequest[] requests; // æå–è¯·æ±‚åˆ—è¡¨
}
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- Node.js >= 16.0.0
- npm æˆ– yarn
- Git

### å®‰è£…ä¾èµ–

```bash
# å…‹éš†é¡¹ç›®
git clone <repository-url>
cd solidity

# å®‰è£…ä¾èµ–
npm install

# ç¼–è¯‘åˆçº¦
npx hardhat compile
```

### ç½‘ç»œé…ç½®

åœ¨ `hardhat.config.js` ä¸­é…ç½®ç½‘ç»œï¼š

```javascript
module.exports = {
  networks: {
    localhost: {
      url: "http://127.0.0.1:8545"
    },
    sepolia: {
      url: "https://sepolia.infura.io/v3/YOUR-PROJECT-ID",
      accounts: ["YOUR-PRIVATE-KEY"]
    }
  }
};
```

## ğŸ“¦ éƒ¨ç½²æŒ‡å—

### 1. æœ¬åœ°å¼€å‘ç½‘ç»œéƒ¨ç½²

```bash
# å¯åŠ¨æœ¬åœ°èŠ‚ç‚¹
npx hardhat node

# æ–°ç»ˆç«¯ï¼šéƒ¨ç½²åˆçº¦
npx hardhat run scripts/Advanced2-contract-stake/deploy.js --network localhost

# æ·»åŠ ETHèµ„é‡‘æ± 
npx hardhat run scripts/Advanced2-contract-stake/addPool.js --network localhost
```

### 2. Sepoliaæµ‹è¯•ç½‘éƒ¨ç½²

```bash
# éƒ¨ç½²åˆ°Sepolia
npx hardhat run scripts/Advanced2-contract-stake/deploy.js --network sepolia

# æ·»åŠ èµ„é‡‘æ± 
npx hardhat run scripts/Advanced2-contract-stake/addPool.js --network sepolia
```

### 3. ä¸»ç½‘éƒ¨ç½²ï¼ˆè°¨æ…æ“ä½œï¼‰

```bash
# ä¸»ç½‘éƒ¨ç½²å‰è¯·å……åˆ†æµ‹è¯•
npx hardhat run scripts/Advanced2-contract-stake/deploy.js --network mainnet
```

## ğŸ§ª æµ‹è¯•æŒ‡å—

### è¿è¡Œæµ‹è¯•å¥—ä»¶

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
npx hardhat test

# è¿è¡Œç‰¹å®šæµ‹è¯•æ–‡ä»¶
npx hardhat test test/Advanced2-contract-stake/MetaNodeStake.test.js

# ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š
npx hardhat coverage
```

### æµ‹è¯•è¦†ç›–èŒƒå›´

- âœ… åˆçº¦éƒ¨ç½²å’Œåˆå§‹åŒ–
- âœ… èµ„é‡‘æ± ç®¡ç†ï¼ˆæ·»åŠ ã€æ›´æ–°ã€æƒé‡è°ƒæ•´ï¼‰
- âœ… ç”¨æˆ·è´¨æŠ¼å’Œæå–æµç¨‹
- âœ… å¥–åŠ±è®¡ç®—å’Œåˆ†å‘
- âœ… æƒé™æ§åˆ¶å’Œå®‰å…¨æ£€æŸ¥
- âœ… ç´§æ€¥æš‚åœåŠŸèƒ½
- âœ… åˆçº¦å‡çº§æœºåˆ¶
- âœ… è¾¹ç•Œæ¡ä»¶å’Œé”™è¯¯å¤„ç†

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

### ç”¨æˆ·æ“ä½œæµç¨‹

#### 1. è´¨æŠ¼ETHè·å¾—å¥–åŠ±

```javascript
// è¿æ¥åˆ°åˆçº¦
const stakeContract = await ethers.getContractAt("MetaNodeStake", contractAddress);

// è´¨æŠ¼1 ETHåˆ°æ± 0ï¼ˆETHæ± ï¼‰
await stakeContract.depositETH({ value: ethers.parseEther("1.0") });

// æŸ¥è¯¢å¾…é¢†å–å¥–åŠ±
const pending = await stakeContract.pendingMetaNode(0, userAddress);
console.log("å¾…é¢†å–å¥–åŠ±:", ethers.formatUnits(pending, 18), "MetaNode");
```

#### 2. é¢†å–å¥–åŠ±

```javascript
// é¢†å–æ± 0çš„æ‰€æœ‰å¥–åŠ±
await stakeContract.claim(0);
```

#### 3. ç”³è¯·æå–è´¨æŠ¼

```javascript
// ç”³è¯·æå–0.5 ETH
await stakeContract.unstake(0, ethers.parseEther("0.5"));

// ç­‰å¾…é”å®šæœŸç»“æŸåæå–
await stakeContract.withdraw(0);
```

### ç®¡ç†å‘˜æ“ä½œ

#### 1. æ·»åŠ æ–°èµ„é‡‘æ± 

```javascript
// æ·»åŠ USDTæ± ï¼ˆå‡è®¾USDTåœ°å€ä¸º0x123...ï¼‰
await stakeContract.addPool(
    "0x123...",              // USDTä»£å¸åœ°å€
    300,                     // æ± æƒé‡
    ethers.parseUnits("10", 6), // æœ€å°è´¨æŠ¼10 USDT
    5760,                    // é”å®š1å¤©ï¼ˆå‡è®¾15ç§’/å—ï¼‰
    true                     // æ›´æ–°æ‰€æœ‰æ± 
);
```

#### 2. è°ƒæ•´æ± æƒé‡

```javascript
// å°†æ± 0çš„æƒé‡è°ƒæ•´ä¸º800
await stakeContract.setPoolWeight(0, 800, true);
```

#### 3. ç´§æ€¥æš‚åœ

```javascript
// æš‚åœæå–åŠŸèƒ½
await stakeContract.pauseWithdraw();

// æš‚åœé¢†å–åŠŸèƒ½
await stakeContract.pauseClaim();

// æ¢å¤åŠŸèƒ½
await stakeContract.unpauseWithdraw();
await stakeContract.unpauseClaim();
```

## ğŸ” å®‰å…¨è€ƒè™‘

### æ™ºèƒ½åˆçº¦å®‰å…¨

- **é‡å…¥æ”»å‡»é˜²æŠ¤**ï¼šä½¿ç”¨OpenZeppelinçš„ReentrancyGuard
- **æ•´æ•°æº¢å‡ºä¿æŠ¤**ï¼šä½¿ç”¨SafeMathåº“å’ŒSolidity 0.8+å†…ç½®æ£€æŸ¥
- **æƒé™æ§åˆ¶**ï¼šåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰
- **æš‚åœæœºåˆ¶**ï¼šç´§æ€¥æƒ…å†µä¸‹å¯æš‚åœå…³é”®åŠŸèƒ½
- **å‡çº§å®‰å…¨**ï¼šUUPSæ¨¡å¼ç¡®ä¿å‡çº§æƒé™æ§åˆ¶

### ç»æµæ¨¡å‹å®‰å…¨

- **å¥–åŠ±è®¡ç®—ç²¾åº¦**ï¼šä½¿ç”¨1e18ç²¾åº¦é¿å…èˆå…¥è¯¯å·®
- **é”å®šæœŸæœºåˆ¶**ï¼šé˜²æ­¢çŸ­æœŸæŠ•æœºå’Œå¥—åˆ©æ”»å‡»
- **æœ€å°è´¨æŠ¼é™åˆ¶**ï¼šé˜²æ­¢ç²‰å°˜æ”»å‡»å’Œgasæµªè´¹
- **æƒé‡å¹³è¡¡**ï¼šåˆç†åˆ†é…å„æ± å¥–åŠ±æ¯”ä¾‹

### è¿è¥å®‰å…¨å»ºè®®

1. **å¤šé‡ç­¾åç®¡ç†**ï¼šä½¿ç”¨å¤šé‡ç­¾åé’±åŒ…ç®¡ç†ç®¡ç†å‘˜æƒé™
2. **é€æ­¥æ”¾æƒ**ï¼šéšç€ç³»ç»Ÿç¨³å®šè¿è¡Œï¼Œé€æ­¥å‡å°‘ä¸­å¿ƒåŒ–æ§åˆ¶
3. **ç›‘æ§å‘Šè­¦**ï¼šå»ºç«‹å®Œå–„çš„é“¾ä¸Šç›‘æ§å’Œå¼‚å¸¸å‘Šè­¦æœºåˆ¶
4. **å®šæœŸå®¡è®¡**ï¼šå®šæœŸè¿›è¡Œæ™ºèƒ½åˆçº¦å®‰å…¨å®¡è®¡
5. **ç¤¾åŒºæ²»ç†**ï¼šé€æ­¥å‘DAOæ²»ç†æ¨¡å¼è½¬å˜

## ğŸ“ˆ ç»æµæ¨¡å‹

### ä»£å¸åˆ†é…

```
MetaNodeä»£å¸æ€»ä¾›åº”é‡ï¼š10,000,000 MetaNode

å»ºè®®åˆ†é…æ–¹æ¡ˆï¼š
â”œâ”€â”€ 70% (7,000,000) â†’ è´¨æŠ¼æŒ–çŸ¿å¥–åŠ±æ± 
â”œâ”€â”€ 15% (1,500,000) â†’ å›¢é˜Ÿå’Œå¼€å‘è€…
â”œâ”€â”€ 10% (1,000,000) â†’ ç¤¾åŒºæ¿€åŠ±å’Œç©ºæŠ•
â””â”€â”€ 5% (500,000)    â†’ æµåŠ¨æ€§æä¾›å’Œäº¤æ˜“æ‰€ä¸Šå¸‚
```

### å¥–åŠ±æœºåˆ¶

- **åŸºç¡€å¥–åŠ±**ï¼šæ¯åŒºå—å›ºå®šæ•°é‡çš„MetaNodeå¥–åŠ±
- **æƒé‡åˆ†é…**ï¼šæ ¹æ®æ± æƒé‡åˆ†é…æ€»å¥–åŠ±
- **ç”¨æˆ·åˆ†æˆ**ï¼šæ ¹æ®ç”¨æˆ·åœ¨æ± ä¸­çš„å æ¯”åˆ†é…æ± å¥–åŠ±
- **å¤åˆ©æ•ˆåº”**ï¼šå¥–åŠ±å¯ä»¥é‡æ–°è´¨æŠ¼è·å¾—æ›´å¤šæ”¶ç›Š

### å‚æ•°ç¤ºä¾‹

```javascript
// ç¤ºä¾‹é…ç½®
const rewardConfig = {
    metaNodePerBlock: "1000000000000000000",  // 1 MetaNode/å—
    ethPoolWeight: 500,                       // ETHæ± æƒé‡50%
    usdtPoolWeight: 300,                      // USDTæ± æƒé‡30%
    btcPoolWeight: 200,                       // WBTCæ± æƒé‡20%
    unstakeLockBlocks: 5760                   // 1å¤©é”å®šæœŸ
};
```

## ğŸ”„ å‡çº§æœºåˆ¶

### UUPSå‡çº§æ¨¡å¼

æœ¬ç³»ç»Ÿé‡‡ç”¨OpenZeppelinçš„UUPSï¼ˆUniversal Upgradeable Proxy Standardï¼‰å‡çº§æ¨¡å¼ï¼š

**ä¼˜åŠ¿ï¼š**
- âœ… Gasæ•ˆç‡é«˜ï¼ˆå‡çº§é€»è¾‘åœ¨å®ç°åˆçº¦ä¸­ï¼‰
- âœ… ä»£ç†åˆçº¦ç®€å•ç¨³å®š
- âœ… æ”¯æŒæƒé™æ§åˆ¶çš„å‡çº§
- âœ… æ•°æ®å­˜å‚¨æŒä¹…åŒ–

**å‡çº§æµç¨‹ï¼š**

```javascript
// 1. éƒ¨ç½²æ–°å®ç°åˆçº¦
const NewImplementation = await ethers.getContractFactory("MetaNodeStakeV2");
const newImpl = await NewImplementation.deploy();

// 2. æ‰§è¡Œå‡çº§ï¼ˆéœ€è¦UPGRADE_ROLEæƒé™ï¼‰
await upgrades.upgradeProxy(proxyAddress, NewImplementation);
```

### å‡çº§æ²»ç†

- **æƒé™è¦æ±‚**ï¼šåªæœ‰å…·æœ‰UPGRADE_ROLEçš„è´¦æˆ·å¯ä»¥æ‰§è¡Œå‡çº§
- **å¤šé‡ç­¾å**ï¼šå»ºè®®ä½¿ç”¨å¤šé‡ç­¾åé’±åŒ…æ§åˆ¶å‡çº§æƒé™
- **æ—¶é—´é”**ï¼šè€ƒè™‘å¼•å…¥æ—¶é—´é”æœºåˆ¶ï¼Œç»™ç”¨æˆ·é¢„ç•™ååº”æ—¶é—´
- **ç¤¾åŒºæŠ•ç¥¨**ï¼šé‡å¤§å‡çº§åº”é€šè¿‡DAOæ²»ç†æŠ•ç¥¨å†³å®š

## ğŸ“ è”ç³»æ–¹å¼

- **é¡¹ç›®åœ°å€**ï¼š[GitHub Repository]
- **æ–‡æ¡£ç½‘ç«™**ï¼š[Documentation Site]
- **ç¤¾åŒºè®¨è®º**ï¼š[Discord/Telegram]
- **é—®é¢˜åé¦ˆ**ï¼š[GitHub Issues]

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ã€‚è¯¦è§ [LICENSE](LICENSE) æ–‡ä»¶ã€‚

---

## ğŸ” å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰

### Q: å¦‚ä½•è®¡ç®—æˆ‘çš„é¢„æœŸæ”¶ç›Šï¼Ÿ

A: æ”¶ç›Šè®¡ç®—å…¬å¼ï¼š
```
ç”¨æˆ·æ”¶ç›Š = (ç”¨æˆ·è´¨æŠ¼é‡ / æ± æ€»è´¨æŠ¼é‡) Ã— æ± æƒé‡ Ã— æ¯åŒºå—å¥–åŠ± Ã— åŒºå—æ•°
```

### Q: ä¸ºä»€ä¹ˆéœ€è¦é”å®šæœŸï¼Ÿ

A: é”å®šæœŸçš„ä½œç”¨ï¼š
- é˜²æ­¢çŸ­æœŸæŠ•æœºè¡Œä¸º
- ç»´æŠ¤ç³»ç»Ÿç¨³å®šæ€§
- ä¿æŠ¤é•¿æœŸè´¨æŠ¼ç”¨æˆ·åˆ©ç›Š
- å‡å°‘é¢‘ç¹äº¤æ˜“çš„gasæ¶ˆè€—

### Q: åˆçº¦å‡çº§ä¼šå½±å“æˆ‘çš„èµ„äº§å—ï¼Ÿ

A: ä¸ä¼šã€‚UUPSå‡çº§æ¨¡å¼ç¡®ä¿ï¼š
- ç”¨æˆ·èµ„äº§å®‰å…¨å­˜å‚¨åœ¨ä»£ç†åˆçº¦ä¸­
- å‡çº§åªæ”¹å˜ä¸šåŠ¡é€»è¾‘ï¼Œä¸å½±å“æ•°æ®
- ä»£ç†åˆçº¦åœ°å€ä¿æŒä¸å˜
- ç”¨æˆ·æ— éœ€è¿›è¡Œä»»ä½•æ“ä½œ

### Q: å¦‚ä½•ç›‘æ§ç³»ç»Ÿè¿è¡ŒçŠ¶æ€ï¼Ÿ

A: å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼ï¼š
- è°ƒç”¨åˆçº¦çš„æŸ¥è¯¢å‡½æ•°
- ç›‘å¬åˆçº¦äº‹ä»¶
- ä½¿ç”¨åŒºå—æµè§ˆå™¨æŸ¥çœ‹äº¤æ˜“
- è¿è¡Œ `tokenInteract.js` è„šæœ¬

### Q: é‡åˆ°é—®é¢˜å¦‚ä½•å¯»æ±‚å¸®åŠ©ï¼Ÿ

A: è¯·æŒ‰ä»¥ä¸‹æ­¥éª¤ï¼š
1. æŸ¥é˜…æœ¬æ–‡æ¡£å’Œä»£ç æ³¨é‡Š
2. åœ¨GitHub Issuesä¸­æœç´¢ç±»ä¼¼é—®é¢˜
3. æäº¤è¯¦ç»†çš„é—®é¢˜æŠ¥å‘Š
4. åŠ å…¥ç¤¾åŒºè®¨è®ºç¾¤ç»„

---

*æœ€åæ›´æ–°ï¼š2024å¹´12æœˆ*

# Task3 åˆçº¦å‡çº§æ¼”ç¤ºè„šæœ¬

## ğŸ“‹ è„šæœ¬æ¦‚è¿°

è¿™ä¸¤ä¸ªè„šæœ¬ä¸“é—¨ç”¨äºæ¼”ç¤º Task3 é¡¹ç›®ä¸­ä»£ç†åˆçº¦å‡çº§åçš„åœ°å€å˜åŒ–æƒ…å†µï¼Œå›ç­”ä½ æå‡ºçš„å…³é”®é—®é¢˜ï¼š

> **æ ¸å¿ƒé—®é¢˜**: å½“ `AuctionNFT.sol` å’Œ `IPriceOracle.sol` å‡çº§åï¼Œ`AuctionFactory.sol` å’Œ `NFTAuction.sol` ä¸­æ¶‰åŠçš„åœ°å€å¦‚ä½•å˜åŒ–ï¼Ÿ

## ğŸ“ è„šæœ¬æ–‡ä»¶

### 1. `upgrade-demo.js` - å®Œæ•´æ¼”ç¤ºè„šæœ¬
- âœ… å®Œæ•´çš„å››é˜¶æ®µæ¼”ç¤ºæµç¨‹
- âœ… è¯¦ç»†çš„åœ°å€å˜åŒ–è¿½è¸ª
- âœ… ä¾èµ–å…³ç³»åˆ†æ
- âœ… åŠŸèƒ½éªŒè¯æµ‹è¯•

### 2. `address-tracking.js` - åœ°å€è¿½è¸ªä¸“ç”¨è„šæœ¬
- âœ… ä¸“æ³¨äºåœ°å€å˜åŒ–å¯¹æ¯”
- âœ… ç®€æ´çš„è¡¨æ ¼æ˜¾ç¤º
- âœ… å¿«é€ŸéªŒè¯ç»“æœ
- âœ… é€‚åˆå¿«é€Ÿæ¼”ç¤º

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### å¿«é€Ÿæ¼”ç¤ºï¼ˆæ¨èï¼‰
```bash
# å¯åŠ¨æœ¬åœ°èŠ‚ç‚¹
npx hardhat node

# åœ¨æ–°ç»ˆç«¯è¿è¡Œåœ°å€è¿½è¸ªæ¼”ç¤º
npx hardhat run scripts/task3/address-tracking.js --network localhost
```

### å®Œæ•´æ¼”ç¤º
```bash
# è¿è¡Œå®Œæ•´çš„å‡çº§æ¼”ç¤º
npx hardhat run scripts/task3/upgrade-demo.js --network localhost
```

## ğŸ“Š æ¼”ç¤ºå†…å®¹

### ç¬¬ä¸€é˜¶æ®µï¼šåˆå§‹éƒ¨ç½²
```
éƒ¨ç½²åˆçº¦                    ä»£ç†åœ°å€                 å®ç°åœ°å€
PriceOracle (ä»£ç†)    â†’    0x5FbDB...              0xe7f17...
AuctionNFT (ä»£ç†)     â†’    0xCf7Ed...              0x9fE46...  
AuctionFactory (ä»£ç†) â†’    0xDc64a...              0x68B1D...
```

### ç¬¬äºŒé˜¶æ®µï¼šåˆ›å»ºæ‹å–
```
ä¾èµ–å…³ç³»å»ºç«‹:
AuctionFactory (0xDc64a...) 
    â†“ ä¾èµ–
PriceOracle (0x5FbDB...)    â† æŒ‡å‘ä»£ç†åœ°å€ï¼

åˆ›å»ºçš„æ‹å–åˆçº¦:
NFTAuction (0xABC...)
    â†“ ç»‘å®š
AuctionNFT (0xCf7Ed...)     â† ç»‘å®šä»£ç†åœ°å€ï¼
```

### ç¬¬ä¸‰é˜¶æ®µï¼šåˆçº¦å‡çº§
```
å‡çº§ç»“æœ:
                      å‡çº§å‰          å‡çº§å          çŠ¶æ€
PriceOracle ä»£ç†:    0x5FbDB...  â†’   0x5FbDB...     âœ… ä¸å˜
PriceOracle å®ç°:    0xe7f17...  â†’   0x123AB...     âœ… å·²å‡çº§

AuctionNFT ä»£ç†:     0xCf7Ed...  â†’   0xCf7Ed...     âœ… ä¸å˜  
AuctionNFT å®ç°:     0x9fE46...  â†’   0x456CD...     âœ… å·²å‡çº§
```

### ç¬¬å››é˜¶æ®µï¼šéªŒè¯ç»“æœ
```
ä¾èµ–å…³ç³»æ£€æŸ¥:
âœ… AuctionFactory ä»æŒ‡å‘ 0x5FbDB... (PriceOracleä»£ç†)
âœ… ç°æœ‰æ‹å–ä»ç»‘å®š 0xCf7Ed... (AuctionNFTä»£ç†)  
âœ… æ‰€æœ‰åŠŸèƒ½æ­£å¸¸å·¥ä½œ
âœ… æ•°æ®å®Œæ•´ä¿ç•™
```

## ğŸ¯ å…³é”®å‘ç°

### â“ ä½ çš„æ‹…å¿ƒ
- âŒ å‡çº§åéœ€è¦é‡æ–°éƒ¨ç½² `AuctionFactory`ï¼Ÿ
- âŒ å‡çº§åéœ€è¦é‡æ–°éƒ¨ç½² `NFTAuction`ï¼Ÿ
- âŒ å‡çº§åä¹‹å‰çš„æ•°æ®ä¼šä¸¢å¤±ï¼Ÿ

### âœ… å®é™…æƒ…å†µ
- âœ… **æ— éœ€é‡æ–°éƒ¨ç½²** - æ‰€æœ‰åˆçº¦ç»§ç»­ä½¿ç”¨åŸåœ°å€
- âœ… **åœ°å€å¼•ç”¨æœ‰æ•ˆ** - å› ä¸ºæŒ‡å‘çš„æ˜¯ä»£ç†åœ°å€
- âœ… **æ•°æ®å®Œæ•´ä¿ç•™** - ä»£ç†åˆçº¦ä¸­çš„çŠ¶æ€ä¸å˜
- âœ… **åŠŸèƒ½è‡ªåŠ¨å‡çº§** - ä»£ç†å†…éƒ¨æŒ‡å‘æ–°å®ç°

## ğŸ“‹ åœ°å€å˜åŒ–è¯¦è§£

### 1. PriceOracle å‡çº§
```javascript
// å‡çº§å‰
AuctionFactory.priceOracle = 0x5FbDB... (ä»£ç†åœ°å€)
ä»£ç† 0x5FbDB... â†’ å®ç° 0xe7f17... (V1)

// å‡çº§å  
AuctionFactory.priceOracle = 0x5FbDB... (ä»£ç†åœ°å€ä¸å˜!)
ä»£ç† 0x5FbDB... â†’ å®ç° 0x123AB... (V2)

// ç»“æœ: AuctionFactory æ— éœ€ä»»ä½•ä¿®æ”¹ï¼Œè‡ªåŠ¨ä½¿ç”¨V2åŠŸèƒ½
```

### 2. AuctionNFT å‡çº§
```javascript
// å‡çº§å‰
NFTAuction.nftContract = 0xCf7Ed... (ä»£ç†åœ°å€)
ä»£ç† 0xCf7Ed... â†’ å®ç° 0x9fE46... (V1)

// å‡çº§å
NFTAuction.nftContract = 0xCf7Ed... (ä»£ç†åœ°å€ä¸å˜!)
ä»£ç† 0xCf7Ed... â†’ å®ç° 0x456CD... (V2)

// ç»“æœ: æ‰€æœ‰æ‹å–åˆçº¦æ— éœ€ä¿®æ”¹ï¼Œè‡ªåŠ¨ä½¿ç”¨V2åŠŸèƒ½
```

## ğŸ” éªŒè¯è¦ç‚¹

### è¿è¡Œè„šæœ¬åæ£€æŸ¥ä»¥ä¸‹å†…å®¹ï¼š

1. **ä»£ç†åœ°å€ä¸å˜**
   ```
   âœ… PriceOracle ä»£ç†: å‡çº§å‰åç›¸åŒ
   âœ… AuctionNFT ä»£ç†: å‡çº§å‰åç›¸åŒ
   âœ… AuctionFactory ä»£ç†: å‡çº§å‰åç›¸åŒ
   ```

2. **å®ç°åœ°å€æ”¹å˜**
   ```
   âœ… PriceOracle å®ç°: å·²æ›´æ–°åˆ°æ–°ç‰ˆæœ¬
   âœ… AuctionNFT å®ç°: å·²æ›´æ–°åˆ°æ–°ç‰ˆæœ¬
   ```

3. **ä¾èµ–å…³ç³»ä¿æŒ**
   ```
   âœ… AuctionFactory â†’ PriceOracle: ä¾èµ–æœ‰æ•ˆ
   âœ… NFTAuction â†’ AuctionNFT: ç»‘å®šæœ‰æ•ˆ
   ```

4. **åŠŸèƒ½æ­£å¸¸å·¥ä½œ**
   ```
   âœ… ç°æœ‰æ‹å–ç»§ç»­å·¥ä½œ
   âœ… æ–°æ‹å–ä½¿ç”¨å‡çº§åŠŸèƒ½
   âœ… æ•°æ®æŸ¥è¯¢æ­£å¸¸
   ```

## ğŸ’¡ æ ¸å¿ƒç†è§£

### ä»£ç†æ¨¡å¼çš„å¨åŠ›
```
ç”¨æˆ·/åˆçº¦è°ƒç”¨
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä»£ç†åˆçº¦   â”‚ â† åœ°å€æ°¸ä¸æ”¹å˜ (0x123...)
â”‚ - å­˜å‚¨æ•°æ®  â”‚
â”‚ - è½¬å‘è°ƒç”¨  â”‚  
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚ delegatecall
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     å‡çº§     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®ç° V1    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â†’    â”‚  å®ç° V2    â”‚
â”‚ - ä¸šåŠ¡é€»è¾‘  â”‚              â”‚ - æ–°é€»è¾‘    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¸ºä»€ä¹ˆä¸éœ€è¦é‡æ–°éƒ¨ç½²ï¼Ÿ
1. **AuctionFactory** å­˜å‚¨çš„æ˜¯ PriceOracle çš„**ä»£ç†åœ°å€**
2. **NFTAuction** ç»‘å®šçš„æ˜¯ AuctionNFT çš„**ä»£ç†åœ°å€**
3. **ä»£ç†åœ°å€æ°¸ä¸æ”¹å˜**ï¼Œåªæ˜¯å†…éƒ¨å®ç°æ›´æ–°
4. **æ‰€æœ‰å¼•ç”¨è‡ªåŠ¨æœ‰æ•ˆ**ï¼Œæ— éœ€ä»»ä½•ä¿®æ”¹

## ğŸ‰ ç»“è®º

**ä»£ç†æ¨¡å¼å®Œç¾è§£å†³äº†ä½ çš„æ‹…å¿ƒï¼**

- ğŸš« **ä¸éœ€è¦**é‡æ–°éƒ¨ç½²ä¾èµ–åˆçº¦
- ğŸš« **ä¸ä¼š**ä¸¢å¤±ä»»ä½•æ•°æ®
- âœ… **å‡çº§æ˜¯é€æ˜çš„**ï¼Œå¯¹å¤–éƒ¨åˆçº¦æ— æ„ŸçŸ¥
- âœ… **åœ°å€å¼•ç”¨æ°¸è¿œæœ‰æ•ˆ**
- âœ… **åŠŸèƒ½è‡ªåŠ¨å‡çº§**

è¿™å°±æ˜¯ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ä»£ç†æ¨¡å¼ - **å‡çº§é€»è¾‘ï¼Œä¿æŒåœ°å€ï¼Œç»´æŠ¤æ•°æ®**ï¼

---

## ğŸ› æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

**Q: è„šæœ¬è¿è¡Œå¤±è´¥ï¼Œæç¤ºåˆçº¦æœªæ‰¾åˆ°**
```bash
A: ç¡®ä¿å…ˆç¼–è¯‘åˆçº¦
npx hardhat compile
```

**Q: å‡çº§å¤±è´¥ï¼Œæç¤ºä¸å…¼å®¹**
```bash
A: æ£€æŸ¥å­˜å‚¨å¸ƒå±€å…¼å®¹æ€§
npx hardhat run scripts/check-compatibility.js
```

**Q: åœ°å€æ˜¾ç¤ºä¸æ­£ç¡®**
```bash
A: é‡å¯æœ¬åœ°èŠ‚ç‚¹ï¼Œæ¸…é™¤ç¼“å­˜
npx hardhat node --reset
```

### è°ƒè¯•æŠ€å·§

1. **æŸ¥çœ‹è¯¦ç»†æ—¥å¿—**
   ```bash
   DEBUG=* npx hardhat run scripts/task3/address-tracking.js
   ```

2. **å•æ­¥è°ƒè¯•**
   ```javascript
   // åœ¨è„šæœ¬ä¸­æ·»åŠ æ–­ç‚¹
   console.log("å½“å‰åœ°å€:", contract.target);
   await new Promise(resolve => setTimeout(resolve, 1000));
   ```

3. **éªŒè¯ä»£ç†çŠ¶æ€**
   ```javascript
   const implAddr = await upgrades.erc1967.getImplementationAddress(proxyAddr);
   console.log("å®ç°åœ°å€:", implAddr);
   ```

---

**ğŸ¯ è¿è¡Œè¿™äº›è„šæœ¬ï¼Œä½ å°†æ¸…æ¥šåœ°çœ‹åˆ°ä»£ç†æ¨¡å¼å¦‚ä½•ä¼˜é›…åœ°è§£å†³åˆçº¦å‡çº§ä¸­çš„åœ°å€ä¾èµ–é—®é¢˜ï¼**
